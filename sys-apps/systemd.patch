Index: systemd-201.ebuild
===================================================================
RCS file: /var/cvsroot/gentoo-x86/sys-apps/systemd/systemd-201.ebuild,v
retrieving revision 1.6
diff -u -B -d -u -p -r1.6 systemd-201.ebuild
--- systemd-201.ebuild	17 Apr 2013 11:01:30 -0000	1.6
+++ systemd-201.ebuild	17 Apr 2013 11:05:47 -0000
@@ -5,7 +5,7 @@
 EAPI=5
 
 PYTHON_COMPAT=( python2_7 )
-inherit autotools-utils linux-info multilib pam python-single-r1 systemd toolchain-funcs udev user
+inherit autotools-utils linux-info multilib python-single-r1 systemd toolchain-funcs udev user usr-gentoo
 
 DESCRIPTION="System and service manager for Linux"
 HOMEPAGE="http://www.freedesktop.org/wiki/Software/systemd"
@@ -81,8 +81,6 @@ src_configure() {
 	local myeconfargs=(
 		--localstatedir=/var
 		--with-firmware-path="/lib/firmware/updates:/lib/firmware"
-		# but pam modules have to lie in /lib*
-		--with-pamlibdir=$(getpam_mod_dir)
 		# make sure we get /bin:/sbin in $PATH
 		--enable-split-usr
 		# disable sysv compatibility
@@ -122,32 +120,16 @@ src_configure() {
 		QUOTACHECK=/usr/sbin/quotacheck
 	)
 
-	# Keep using the one where the rules were installed.
-	MY_UDEVDIR=$(get_udevdir)
-
 	# Work around bug 463846.
 	tc-export CC
 
 	autotools-utils_src_configure
 }
 
-src_compile() {
-	autotools-utils_src_compile \
-		udevlibexecdir="${MY_UDEVDIR}"
-}
-
 src_install() {
 	autotools-utils_src_install -j1 \
-		udevlibexecdir="${MY_UDEVDIR}" \
 		dist_udevhwdb_DATA=
 
-	# keep udev working without initramfs, for openrc compat
-	dodir /bin /sbin
-	mv "${D}"/usr/lib/systemd/systemd-udevd "${D}"/sbin/udevd || die
-	mv "${D}"/usr/bin/udevadm "${D}"/bin/udevadm || die
-	dosym ../../../sbin/udevd /usr/lib/systemd/systemd-udevd
-	dosym ../../bin/udevadm /usr/bin/udevadm
-
 	# zsh completion
 	insinto /usr/share/zsh/site-functions
 	newins shell-completion/systemd-zsh-completion.zsh "_${PN}"
@@ -185,11 +167,14 @@ src_install() {
 
 	# Check whether we won't break user's system.
 	local x
-	for x in /bin/systemd /usr/bin/systemd \
-		/usr/bin/udevadm /usr/lib/systemd/systemd-udevd
+	for x in /bin/systemd /usr/bin/systemd
 	do
 		[[ -x ${D}${x} ]] || die "${x} symlink broken, aborting."
 	done
+
+	usr_wrap_bin systemadm udevadm
+	path-compat-mkwrap /sbin/udevadm /usr/bin/udevadm
+	path-compat-mkwrap /sbin/udevd /usr/lib/systemd/systemd-udevd
 }
 
 optfeature() {
